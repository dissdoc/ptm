<script type="text/javascript">
    var markers = null;
    var map = null;

    function initialize() {
        var myLatlng = new google.maps.LatLng(-34.397, 150.644);
        var myOptions = {
            zoom: 3,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            streetViewControl: false,
            mapTypeControl: false
        }
        map = new google.maps.Map(document.getElementById("fullmap"), myOptions);
        google.maps.event.addListener(map, 'idle', getBounds);

        markers = initMarkers(map);        
    }   

    function initMarkers(map) {
        var markers = new Array();
        <% photos.each do |photo| %>
            <% if photo.geo.present? && photo.geo.latitude.present? && photo.geo.longitude.present? %>
                var latlng = new google.maps.LatLng("<%= photo.geo.latitude %>", "<%= photo.geo.longitude %>");
                var marker = new google.maps.Marker({
                    position: latlng, 
                    map: map,
                    icon: '/assets/GoogleMap_Gray.png'
                });
                addListenerMarker(marker, "<%= photo.id %>");
                markers["<%= photo.id %>"] = marker;
            <% end %>
        <% end %>
        return markers;
    }

    function addListenerMarker(marker, id) {
        google.maps.event.addListener(marker, 'mouseover', function() {
            overIconMarker(marker);
            over($('li#' + id));
        });

        google.maps.event.addListener(marker, 'mouseout', function() {
            outIconMarker(marker);
            out($('li#' + id));
        });

        google.maps.event.addListener(marker, 'click', function() {
            window.location.href = '/photos/' + id;
        });
    }

    function overIconMarker(marker) {
        marker.setIcon('/assets/GoogleMap_Pink.png');
    }

    function outIconMarker(marker) {
        marker.setIcon('/assets/GoogleMap_Gray.png');    
    }

    function over(item) {
        var img = item.find('img').position();
        var top = img.top - 20;
        var left = img.left - 20;
        item.find('div').css({'display': 'block', 'top': top, 'left': left});    
    }

    function out(item) {
        item.find('div').css({'display': 'none'});    
    }

    function findMarker(key) {
        return markers[key];
    }

    $('ul#thumbs li').hover(
        function() { 
            over($(this)); 
            var marker = findMarker($(this).attr('id'));
            overIconMarker(marker);
        },
        function() { 
            out($(this)); 
            var marker = findMarker($(this).attr('id'));
            outIconMarker(marker);
        }
    );

    function getBounds() {
        var currentBounds = map.getBounds();

        $('#ne_lng').val(currentBounds.getNorthEast().lng());
        $('#ne_lat').val(currentBounds.getNorthEast().lat());
        $('#sw_lng').val(currentBounds.getSouthWest().lng());
        $('#sw_lat').val(currentBounds.getSouthWest().lat());
    } 
</script>