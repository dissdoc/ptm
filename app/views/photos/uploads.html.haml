= form_for @photo, :html => { :multipart => true }, :url => photos_uploaded_path, :method => :post  do |f|
  = f.file_field :image

  %div
    = f.label :tag_names, "Tags"
    = f.text_field :tag_names

  %div
    = f.label 'Set a title'
    = f.text_field :comment

  %p
    %h3 Geolocation

    = f.fields_for :geo do |location|
      %div
        %label Address:
        = location.text_field :address, :id => 'address'

        = hidden_field_tag 'lat', '-34.397'
        = hidden_field_tag 'lng', '150.644'
      %div#map_canvas

  %p
    = f.fields_for :share_photo do |sharing|
      %label Public ?
      = sharing.check_box :share

  %div
    = f.label "Generate at"
    = f.datetime_select :generate, :start_year => 1826, :end_year => Time.now.year - 15
  %div
    = f.label "End of generate at"
    = f.datetime_select :generate_end, :start_year => 1826, :end_year => Time.now.year - 15

  = f.submit "Add"


%div#container
  %div#filelist
  = link_to 'Select files', '#', :id => 'pickfiles'
  = link_to 'Uploads', '#', :id => 'uploadfiles'

%script{ :type => "text/javascript",  :src => "/assets/plupload.full.js"}
:javascript
  $(function() {
    var uploader = new plupload.Uploader({
      runtimes : 'html5',
      browse_button : 'pickfiles',
      container : 'container',
      max_file_size : '10mb',
      //url : 'upload.php',
      //flash_swf_url : '/plupload/js/plupload.flash.swf',
      filters : [
        {title : "Image files", extensions : "jpg,gif,png"},
        {title : "Zip files", extensions : "zip"}
      ],
      resize : {width : 320, height : 240, quality : 90}
    });

    uploader.bind('Init', function(up, params) {
      $('#filelist').html("<div>Current runtime: " + params.runtime + "</div>");
    });

    $('#uploadfiles').click(function(e) {
      uploader.start();
      e.preventDefault();
    });

    uploader.init();

    uploader.bind('FilesAdded', function(up, files) {
      $.each(files, function(i, file) {
        $('#filelist').append(
          '<div id="' + file.id + '">' +
          file.name + ' (' + plupload.formatSize(file.size) + ') <b></b>' +
          '</div>'
        );
      });
      up.refresh();
    });

    uploader.bind('UploadProgress', function(up, file) {
      $('#' + file.id + " b").html(file.percent + "%");
    });

    uploader.bind('Error', function(up, err) {
      $('#filelist').append("<div>Error: " + err.code +
      ", Message: " + err.message +
      (err.file ? ", File: " + err.file.name : "") +
      "</div>");
      up.refresh();
    });

    uploader.bind('FileUploaded', function(up, file) {
      $('#' + file.id + " b").html("100%");
    });
  });
