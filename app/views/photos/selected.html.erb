<% content_for(:head) do  %>
    <script src="/assets/jquery.min.js"></script>
    <script src="/assets/jquery.imgareaselect.min.js"></script>
    <script src="/assets/jquery.imgnotes-0.2.js"></script>
    <link rel="stylesheet" href="/assets/imgareaselect-default.css" type="text/css" />
    <link rel="stylesheet" href="/assets/imgnotes.css" type="text/css" />

    <script language="Javascript">
        jQuery(function($) {
            notes = [];
            <% @photo.areatags.each do |areatag| %>
                notes.push({"x1": "<%= areatag.x %>",
                            "y1": "<%= areatag.y %>",
                            "height": "<%= areatag.height %>",
                            "width": "<%= areatag.width %>",
                            "note": "<%= areatag.description.gsub(/\r/," ").gsub(/\n/," ") %>" });
            <% end %>

            $('#imgselectarea').imgNotes();
            $('#imgselectarea').imgAreaSelect({
                handles: true,
                onSelectChange:showaddnote
            });

            $('#cancelnote').click(function(){
                $('#imgselectarea').imgAreaSelect({ hide: true, disable:true });
                $('#noteform').hide();
            });

            $('#addnotelink').click(function(){
                $('#imgselectarea').imgAreaSelect({ enable:true, onSelectChange: showaddnote, x1: 120, y1: 90, x2: 280, y2: 210 });
                return false;
            });
        });

        function showaddnote (img, area) {
            imgOffset = $(img).offset();
            form_left  = parseInt(imgOffset.left) + parseInt(area.x1);
            form_top   = parseInt(imgOffset.top) + parseInt(area.y1) + parseInt(area.height)+5;

            $('#noteform').css({ left: form_left + 'px', top: form_top + 'px'});

            $('#noteform').show();

            $('#noteform').css("z-index", 10000);
            $('#NoteX1').val(area.x1);
            $('#NoteY1').val(area.y1);
            $('#NoteHeight').val(area.height);
            $('#NoteWidth').val(area.width);

        }
    </script>
<% end %>

<a href="#" id="addnotelink">Add a tag</a>

<%= image_tag @photo.image.url(:large), :id => "imgselectarea" %>

<div id="noteform">
  <%= form_tag addarea_album_photo_url(@album, @photo), :id => "NoteAddForm", :method => :post do %>
    <fieldset>
        <%= hidden_field_tag :x1, params[:x1], :id => 'NoteX1' %>
        <%= hidden_field_tag :y1, params[:y1], :id => 'NoteY1' %>
        <%= hidden_field_tag :height, params[:height], :id => 'NoteHeight' %>
        <%= hidden_field_tag :width, params[:width], :id => 'NoteWidth' %>
        <%= text_area_tag :description, params[:description], :id => 'NoteNote' %>
    </fieldset>
    <div class="action">
      <%= submit_tag "Add" %>
      <input type="button" value="Cancel" id="cancelnote">
    </div>
  <% end %>
</div>

<p>
  <% @photo.areatags.each do |areatag| %>
    <div>
      #<%= areatag.id %>
      :
      <%= areatag.description %>

      <% if signed_in? %>
        <% if current_user.admin_of_photo?(@photo) || current_user.admin_of_areatag?(@photo, areatag) %>
          <%= link_to "X", deletearea_album_photo_path(@album, @photo, :area => areatag), :method => :post %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</p>